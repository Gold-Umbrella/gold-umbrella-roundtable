name: Daily Round Table Oracle

on:
  schedule:
    - cron: '33 3 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install openai
      - name: Normalize report files to UTF-8
        run: |
          python - <<'PY'
          from pathlib import Path

          for f in ["reports/index.json", "reports/latest.json"]:
          p = Path(f)
          if not p.exists():
            continue

          b = p.read_bytes()

          if b.startswith(b"\xff\xfe") or b.startswith(b"\xfe\xff"):
            text = b.decode("utf-16")
          elif b.startswith(b"\xef\xbb\xbf"):
            text = b.decode("utf-8-sig")
          else:
            text = b.decode("utf-8", errors="strict")

            p.write_text(text, encoding="utf-8", newline="\n")

            print("Normalized reports files to UTF-8")
            PY
      - name: Run daily generator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python engine/generate_report.py

      - name: Commit updated reports
        run: |
          git config user.name "gold-umbrella-bot"
          git config user.email "bot@goldumbrella.dev"
          git add reports/
          git commit -m "Daily oracle report" || echo "No changes to commit"
          git push
